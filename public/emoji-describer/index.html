<!DOCTYPE html>
<html>
<head>
	<title x-data="{title: '', reset() {this.title = $store.config.nameOfGame}, addCode(code) {this.title = `${$store.config.nameOfGame} - ${code}`}}" @movetolobby.window="addCode($event.detail.lobbyCode)" @begingame.window="addCode($event.detail.lobbyCode)" @leavelobby.window="reset()" x-init="reset()" x-text="title">Emoji Describer</title>
	<link rel="icon" href="https://openmoji.org/data/color/svg/1F63C.svg">
	<script src="script.js"></script>
	<script src="config.js"></script>
	<script src="emojis.js"></script>
	<script src="jquery-3.6.0.min.js"></script>
	<script defer src="alpine-3.10.5.min.js"></script>
	<link rel="stylesheet" href="output.css">
</head>
<body>
	<div class="h-screen max-h-screen bg-green-300 flex flex-col">
		<template x-if="$store.config.devMode" x-data="$store.pages">
			<div class="border-2 border-solid border-black border-b p-2">
				<div class="flex justify-between" x-data="$store.config">
					<p>Navigate through pages here</p>
					<button x-bind="test">raw</button>
					<button class="bg-stone-300 border border-black rounded-lg p-1" type="button" @click="localMode = !localMode" x-text="localMode ? 'Local mode' : 'Online mode'"></button>
				</div>
				<div class="flex gap-2">
					<template x-for="page in list">
						<button @click="$dispatch('navigateto', page)" x-text="page" class="bg-stone-300 border border-black rounded-lg p-0.5"></button>
					</template>
				</div>
			</div>
		</template>
		<div class="flex flex-col justify-center items-center bg-yellow-300 grow overflow-hidden" @unexpectederror="alert(`Error: ${$event.detail.details}`)" x-data>
			<div data-page="landing" class="border border-black flex flex-col justify-between items-center gap-12 py-6 px-10 bg-orange-300" x-cloak x-show="$store.pages.currentPage == $el.dataset.page" x-data="login" @connected.window="loggingIn = false" @connectionfailed.window="loggingIn = false">
					<div class="flex flex-col justify-center items-center gap-4">
						<div class="font-bold" x-show="code">
							<span>Join game </span>
							<span x-text="code"></span>
						</div>
						<input class="border border-black" type="text" autocomplete="off" placeholder="Enter a name..." @keyup.enter="login()" @input="username = username.replace(/[^A-Za-z0-9 ]/g, '').replace(/^ /, '').replace(/(?<=.{15}).$/g, '')" x-model="username"></input>
						<button class="bg-stone-300 border border-black rounded-lg p-0.5 px-3 disabled:opacity-50" :class="{'text-orange-500': loggingIn}" type="button" :disabled="!validUsername() || loggingIn" @click="login()" x-text="code ? (loggingIn ? 'Joining...' : 'Join') : (loggingIn ? 'Connecting...' : 'Play')"></button>
					</div>
				<p>All emojis designed by <a class="underline text-blue-500" href="https://openmoji.org/" rel="nofollow">OpenMoji</a> â€“ the open-source emoji and icon project. License: <a class="underline text-blue-500" href="https://creativecommons.org/licenses/by-sa/4.0/#" rel="nofollow">CC BY-SA 4.0</a></p>
			</div>
			<div data-page="home" class="grid grid-cols-5 grid-rows-2 border border-black bg-blue-300 h-4/6 w-5/12" x-cloak x-show="$store.pages.currentPage == $el.dataset.page" @leavelobby.window="$dispatch('navigateto', $el.dataset.page)" @lobbydeleted.window="$dispatch('navigateto', $el.dataset.page); alert('The lobby you were in was deleted');" x-data>
				<div class="col-span-2 row-span-1 bg-red-400 p-8 flex items-center justify-center grow" x-data="{creating: false}" @movetolobby.window="creating = false" @alreadyinlobby.window="alert(`Failed to ${$event.detail.intent} lobby as you are already in one. If this seems to be an error, close the tab and try again.`); creating = false;" @unexpectederror.window="creating = false">
					<button class="border border-black rounded-lg p-1 transition hover:rotate-6 hover:ease-in hover:duration-75" :class="{'text-orange-500': creating}" type="button" @click="$dispatch('send', {type: 'createLobby'}); creating = true;" x-text="creating ? 'Creating...' : 'Create new game'"></button>
				</div>
				<div class="col-start-1 col-span-2 row-start-2 row-end-2 flex flex-col gap-2 bg-teal-400 p-8 grow items-center justify-center" x-data="joinLobby" @movetolobby.window="joining = false" @lobbynotfound.window="notFound()" @invalidlobbycode.window="invalidCode()" @alreadyinlobby.window="joining = false" @unexpectederror.window="joining = false">
					<input type="text" placeholder="Enter code here" @input="code = code.replace(/[^A-Za-z]/g, '').replace(/(?<=.{5}).$/g, '').toUpperCase()" @keyup.enter="join()" x-model="code"></input>
					<button class="border border-black rounded-lg p-1 transition enabled:hover:rotate-6 enabled:hover:ease-in enabled:hover:duration-75 disabled:opacity-50" :class="{'text-orange-500': joining}" @click="join()" type="button" :disabled="!/^[A-Z]{5}$/.test(code) || joining" x-text="joining ? 'Joining...' : 'Join game'"></button>
				</div>
				<div class="col-start-3 col-span-3 row-start-1 row-span-2 flex flex-col justify-between items-center p-4 gap-2">
					<h1>Global chat</h1>
					<div class="flex flex-col grow bg-white w-full h-full overflow-y-auto break-words" @globalchatmessage.window="messages.push($event.detail); scrollIfScrolled($el);" x-data="chatWindow">
						<template x-for="m in messages">
							<span x-text="`${m.sender}${m.isSender ? ' (You)' : ''}: ${m.message}`"></span>
						</template>
					</div>	
					<div class="flex gap-2" x-data="chatSend('globalChatMessage')">
						<input type="text" x-model="message" @keyup.enter="send()"></input>
						<button class="border border-black rounded-lg p-1" type="button" @click="send()" :disabled="!validMessage()">Send</button>
					</div>
				</div>
			</div>
			<div data-page="lobby" class="flex flex-col border border-black bg-rose-400 justify-between gap-4 h-4/6 w-5/12 overflow-hidden" x-cloak x-show="$store.pages.currentPage == $el.dataset.page"  x-data="{others: [], refresh(list) {this.others = list}}" @movetolobby.window="$dispatch('navigateto', $el.dataset.page)">
				<div class="bg-slate-300 flex items-center justify-center gap-6" x-data="{lobbyCode: ''}" @movetolobby.window="lobbyCode = $event.detail.lobbyCode">
					<div>
						<span>Lobby code: </span>
						<span class="font-bold" x-text="lobbyCode"></span>
					</div>
					<button class="border border-black rounded-lg p-1" :class="{'text-green-500': copied}" type="button" x-data="{copied: false}" @click="navigator.clipboard.writeText(`${window.location.href.replace(/\?.*$/, '')}?directJoin=${lobbyCode}`); copied = true; setTimeout(() => copied = false, 750)" x-text="copied ? 'Copied!' : 'Invite ðŸ”—'"></button>
				</div>
				<div class="bg-orange-200 grow grid grid-cols-5 grid-rows-2 gap-2 overflow-hidden">
					<div class="col-span-2 row-span-1 bg-gray-200 overflow-auto">
						<div class="flex flex-col gap-1"> <!-- <div class="flex flex-wrap gap-2"> may be more desirable -->
							<div class="text-blue-500 font-medium" x-data="{you: ''}" @movetolobby.window="you = $event.detail.you">
								<span x-text="you"></span>
								<span> (you)</span>
							</div>
							<template x-for="(other, index) in others" @movetolobby.window="refresh($event.detail.otherPlayers)" @playerjoinedlobby.window="refresh($event.detail.otherPlayers)" @playerleftlobby.window="refresh($event.detail.newOtherPlayers)">
								<div class="font-medium" :class="$store.config.lobbyPlayerColours[index%$store.config.lobbyPlayerColours.length]" x-text="other"></div>
							</template>
						</div>
					</div>
					<div class="col-start-1 col-span-2 row-start-2 row-span-1 flex flex-col bg-slate-500 gap-4"  x-data="settings" @movetolobby.window="settingsChanged($event.detail.settings)" @settingchanged.window="settingChanged($event.detail.setting, $event.detail.newValue)">
						<div class="flex">
							<div class="flex flex-col">
								<div class="border-b border-black">
									<label title="The only mode, currently">
										<input type="radio" name="mode" :checked="mode == 'FFA'">
										Free-for-All
									</label>
								</div>
								<div class="flex flex-col">
									<div>
										<label title="The describer only has a limited amount of time to describe the prompt">
											<input type="checkbox" @click="changeSetting('timer', !timer)" x-model="timer">
											Timer
										</label>
										<select @change="changeSetting('timerTime', timerTime)" x-model.number="timerTime" :disabled="!timer">
											<template x-for="time in $store.config.offeredTimerTimes">
												<option :value="time" x-text="time"></option>
											</template>
										</select>
									</div>
									<label title="The describer can choose a prompt from a set of options">
										<input type="checkbox" @click="changeSetting('promptOptions', !promptOptions)" x-model="promptOptions">
										Prompt options
									</label>
									<label title="The guessers get the scaffold of the prompt e.g. '_ _ _   _ _ _ _ _   _ _ _ _ _ _">
										<input type="checkbox" @click="changeSetting('promptMasks', !promptMasks)" x-model="promptMasks">
										Prompt masks
									</label>
								</div>
							</div>
							<div class="flex flex-col">
								<div class="border-b border-black">
									<label title="Teams mode - coming soon?">
										<input type="radio" name="mode" x-model="mode" disabled>
										Teams
									</label>
								</div>
								<div class="flex">
									<label title="The winning team is the team that guesses the prompt the fastest">
										<input type="radio" name="teamsBasis" disabled>
										Fastest
									</label>
									<label title="The winning team is the team that guesses the prompt using the fewest emojis">
										<input type="radio" name="teamsBasis" disabled>
										Fewest emojis
									</label>
								</div>
							</div>
						</div>
						<div class="border-t border-black">
							<label title="The number of rounds the game will last for, where each round consists of each player taking a turn as the describer">
								Rounds
								<select @change="changeSetting('rounds', rounds)" x-model.number	="rounds">
									<template x-for="i in 10">
										<option :value="i" x-text="i"></option>
									</template>
								</select>
							</label>
						</div>
					</div>
					<div class="col-start-3 col-span-3 row-start-1 row-span-2 flex flex-col justify-between p-4 bg-slate-700" x-data="{isLobby: true}">
						<h1 class="self-center">Chat</h1>
						<div class="flex self-start gap-0.5">
							<button class="rounded-t-lg p-1" :class="isLobby ? 'bg-white' : 'bg-gray-300'" @click="isLobby = !isLobby" :disabled="isLobby">Lobby</button>
							<button class="rounded-t-lg p-1" :class="!isLobby ? 'bg-white' : 'bg-gray-300'" @click="isLobby = !isLobby" :disabled="!isLobby">Global</button>
						</div>
						<div class="flex flex-col gap-2 grow overflow-hidden" x-show="isLobby">
							<div class="flex flex-col bg-white h-full w-full overflow-y-auto break-words" @lobbychatmessage.window="messages.push($event.detail); scrollIfScrolled($el);" x-data="chatWindow">
								<template x-for="m in messages">
									<span x-text="`${m.sender}${m.isSender ? ' (You)' : ''}: ${m.message}`"></span>
								</template>
							</div>	
							<div class="self-center flex gap-2" x-data="chatSend('lobbyChatMessage')">
								<input type="text" x-model="message" @keyup.enter="send()"></input>
								<button class="border border-black rounded-lg p-1" type="button" @click="send()" :disabled="!validMessage()">Send</button>
							</div>
						</div>
						<div class="flex flex-col gap-2 grow overflow-hidden" x-cloak x-show="!isLobby">
							<div class="flex flex-col bg-white h-full w-full overflow-y-auto break-words" @globalchatmessage.window="messages.push($event.detail); scrollIfScrolled($el);" x-data="chatWindow">
								<template x-for="m in messages">
									<span x-text="`${m.sender}${m.isSender ? ' (You)' : ''}: ${m.message}`"></span>
								</template>
							</div>	
							<div class="self-center flex gap-2" x-data="chatSend('globalChatMessage')">
								<input type="text" x-model="message" @keyup.enter="send()"></input>
								<button class="border border-black rounded-lg p-1" type="button" @click="send()" :disabled="!validMessage()">Send</button>
							</div>
						</div>
					</div>
				</div>
				<div class="bg-lime-300 flex items-center justify-center gap-6">
					<button class="border border-black rounded-lg p-1" :class="{'text-orange-500': starting}" type="button" @click="$dispatch('send', {type: 'startGame'}); starting = true;" @begingame.window="starting = false" @unexpectederror.window="starting = false" x-data="{starting: false}" :disabled="starting || others.length === 0" x-text="starting ? 'Starting...' : 'Start game'"></button>
					<button class="border border-black rounded-lg p-1" :class="{'text-orange-500': leaving}" type="button" @click="$dispatch('send', {type: 'leaveLobby'}); leaving = true;" @leavelobby.window="leaving = false" @unexpectederror.window="leaving = false" x-data="{leaving: false}" :disabled="leaving" x-text="leaving ? 'Leaving...' : 'Leave'"></button>
				</div>
			</div>
			<div data-page="game" class="border border-black grid grid-cols-6 h-5/6 w-3/4 overflow-hidden" x-cloak x-show="$store.pages.currentPage == $el.dataset.page" x-data="game" @begingame.window="updateGameStarted($event.detail)" @continuegame.window="updateGameContinued($event.detail)" @playerjoinedgame.window="updateState($event.detail)" @playerleftgame.window="updatePlayerLeft($event.detail)" @promptselected.window="updatePromptSelected($event.detail)" @gameended.window="updateGameEnded($event.detail)">
				<div class="col-span-1 flex flex-col bg-lime-200 gap-2">
					<span class="font-bold text-center border-b border-black">Players</span>
					<div>
						<div class="flex gap-1">
							<div class="flex">
								<span>[</span>
								<span x-text="you?.score"></span>
								<span>]</span>
							</div>
							<span x-text="you?.username"></span>
							<span>(you)</span>
							<span x-show="youAreDescriber">âœŽ</span>
						</div>
						<div class="flex gap-1" x-show="describer && !youAreDescriber">
							<div class="flex">
								<span>[</span>
								<span x-text="describer?.score"></span>
								<span>]</span>
							</div>
							<span x-text="describer?.username"></span>
							<span>âœŽ</span>
						</div>
						<template x-for="player in otherPlayers">
							<div class="flex gap-1">
								<div class="flex">
									<span>[</span>
									<span x-text="player.score"></span>
									<span>]</span>
								</div>
								<span x-text="player.username"></span>
							</div>
						</template>
					</div>
				</div>
				<div class="col-span-3 flex flex-col justify-start bg-lime-400 gap-2 border-x border-black overflow-hidden">
					<div class="basis-auto flex justify-between border-b border-black shrink-0 bg-amber-200 font-bold">
						<div class="flex gap-1 bg-fuchsia-200">
							<div class="flex gap-1">
								<span>Round</span>
								<span x-text="round"></span>
								<span>of</span>
								<span x-text="maxRounds"></span>
							</div>
						</div>
						<div class="flex gap-1 justify-center bg-fuchsia-400">
							<div class="flex gap-1" x-show="waitingForSelection">
								<span x-text="describer?.username"></span>
								<span>is selecting a prompt</span>
							</div>
							<div x-show="!waitingForSelection">
								<div class="flex gap-1" x-show="youAreDescriber">
									<span>Describe</span>
									<span x-text="prompt"></span>
									<div class="flex">
										<span>(</span>
										<span x-text="category"></span>
										<span>)</span>
									</div>
								</div>
								<div x-show="!youAreDescriber">
									<div class="flex gap-1" x-show="!gameOver">
										<span class="whitespace-pre tracking-wider" x-show="promptMask" x-text="promptMask"></span>
										<div class="flex">
											<span x-show="promptMask">(</span>
											<span x-text="category"></span>
											<span x-show="promptMask">)</span>
										</div>
									</div>
									<span x-show="gameOver">Game over!</span>
								</div>
							</div>
						</div>
						<div class="bg-fuchsia-600">
							<span class="text-red-500" x-data="timer" @begingame.window="startTimer($event.detail.timeTurnEnding)" @continueGame.window="startTimer($event.detail.timeTurnEnding)" @gameended.window="cancel()" x-text="timeRemaining" x-show="active"></span>
						</div>
					</div>
					<div class="basis-auto flex flex-col items-center gap-2 bg-pink-300" x-show="youAreDescriber && waitingForSelection" x-data="{selecting: false}" @promptselected.window="selecting = false" @unexpectederror.window="selecting = false">
						<span class="font-bold" :class="{'text-orange-500': selecting}" x-text="selecting ? 'Selecting...' : 'Choose a prompt'"></span>
						<div class="flex justify-around gap-2 w-full">
							<template x-for="(option, index) in promptOptions">
								<div class="flex flex-col border items-center border-black p-2 hover:bg-slate-400" :class="{'cursor-pointer': !selecting, 'cursor-default opacity-50': selecting}" @click="if (!selecting) $dispatch('send', {type: 'selectPrompt', promptNumber: index + 1}); selecting = true">
									<span class="font-bold" x-text="option.category"></span>
									<span x-text="option.prompt"></span>
								</div>
							</template>
						</div>
					</div>
					<div class="basis-19 grow flex flex-col items-center bg-yellow-300 max-h-full overflow-y-auto" x-data="{clues: []}" @incomingclue.window="clues.push($event.detail.clue); $nextTick(() => {$el.scrollTop = $el.scrollHeight});" @begingame.window="clues = []" @continuegame.window="clues = []">
						<template x-for="clue in clues">
							<div class="flex">
								<template x-for="code in clue">
									<img class="w-18 h-18" :src="$store.config.localMode ? `../emojis/images/${code}.png` : `https://openmoji.org/data/color/svg/${code}.svg`" :alt="emojis[code].name", :title="emojis[code].name">
								</template>
							</div>
						</template>
					</div>
					<div class="basis-auto flex flex-col items-center justify-end w-full bg-blue-300 overflow-hidden" x-show="youAreDescriber && !waitingForSelection" x-data="{query: '', searchResults: [], clue: [], search() {this.searchResults = getMatchingEmojis(this.query); if (!this.fastSearch) this.query = '';}, fastSearch: false}" @begingame.window="if ($event.detail.youAreDescriber && !$event.detail.waitingForSelection) searchResults = getRandomEmojis()" @continuegame.window="if ($event.detail.youAreDescriber && !$event.detail.waitingForSelection) searchResults = getRandomEmojis()" @promptselected.window="if ($event.detail.youAreDescriber) searchResults = getRandomEmojis()"> <!-- This could also be unplayable on small heights... Considering adding a query to change to remove auto and shrink-0 with basis-full, and use basis-full on the above div instead of grow -->
						<div class="basis-19 items-end flex w-full justify-between overflow-hidden bg-red-200"> <!-- This will make clues unusable on very small heights (search results are not shown as this covers them); consider having breakpoints to remove the shrink-0 class -->
							<div></div>
							<div x-ref="cluePreview" class="flex flex-wrap items-end justify-start border-x border-t border-black bg-slate-300 max-h-full overflow-y-auto">
								<div class="flex flex-col items-center bg-emerald-500" x-show="clue.length === 0">
									<span>Click on emojis to add them to your clue</span>
									<span>Click send when your clue is ready</span>
								</div>
								<template x-for="code in clue">
									<img class="w-18 h-18" :src="$store.config.localMode ? `../emojis/images/${code}.png` : `https://openmoji.org/data/color/svg/${code}.svg`">	
								</template>
							</div>
							<div class="shrink-0">
								<button class="border border-black rounded-lg p-0.5" type="button" @click="clue.pop()">Undo</button>
								<button class="border border-black rounded-lg p-0.5" type="button" @click="clue = []">Clear</button>
								<button class="border border-black rounded-lg p-0.5" :class="{'text-orange-500': sending}" type="button" @click="$dispatch('send', {type: 'sendClue', clue: clue}); clue = []; sending = true;" :disabled="sending" @incomingclue.window="sending = false" @unexpectederror.window="sending = false" x-data="{sending: false}">Send</button>
							</div>
						</div>
						<div class="border-t border-black w-full flex flex-wrap items-center justify-center max-h-37 overflow-y-auto bg-red-400">
							<span x-show="searchResults.length === 0">No results</span>
							<template x-for="code in searchResults">
								<img class="w-18 h-18 cursor-pointer hover:bg-purple-400" :src="$store.config.localMode ? `../emojis/images/${code}.png` : `https://openmoji.org/data/color/svg/${code}.svg`" :alt="emojis[code].name", :title="emojis[code].name" @click="clue.push(code); $nextTick(() => $refs.cluePreview.scrollTop = $refs.cluePreview.scrollHeight);">
							</template>
						</div>
						<div class="flex gap-2 border-t justify-center border-black w-full bg-red-600">
							<input type="text" placeholder="Search for emojis here..." @keyup.enter="search()" @input.debounce="if (fastSearch) search()" x-model="query">
							<button type="button" @click="search()">Search</button>
							<label title="Search results appear as you type - uses more data and requires a fast connection to work well">
								<input type="checkbox" x-model="fastSearch">
								Fast search
							</label>
						</div>
					</div>
				</div>
				<div class="col-span-2 flex flex-col justify-between bg-lime-600 overflow-hidden">
					<span class="font-bold text-center border-b border-black">Guess</span>
					<div x-ref="guesses" class="flex flex-col grow justify-start overflow-y-auto" x-data="guesses" @begingame.window="showBegin($event.detail)" @continuegame.window="showProgress($event.detail)" @promptselected.window="showSelected($event.detail)" @incomingguess.window="showGuess($event.detail)" @promptguessed.window="showCorrectGuess($event.detail)" @turntimedout.window="showTimeout($event.detail)" @gameended.window="showEnded($event.detail)" @playerleftgame.window="showPlayerLeft($event.detail)">
						<template x-for="message in messages">
							<span x-text="message"></span>
						</template>
					</div>
					<div class="flex justify-between gap-2 border-t border-black" x-data="{guess: '', makeGuess() {$dispatch('send', {type: 'sendGuess', guess: this.guess}); this.guess = '';}}" x-show="!youAreDescriber">
						<input class="grow" type="text" placeholder="Guess here..." x-model="guess" @keyup.enter="makeGuess()">
						<button type="button" @click=makeGuess()>Guess</button>
					</div>
				</div>
			</div>
			<div data-page="test" x-cloak x-show="$store.pages.currentPage == $el.dataset.page" x-data>
				<p>Test</p>
			</div>
		</div>
		<div class="basis-1/12 shrink-0 bg-purple-300">
			<!-- Used to make the content slightly more on the top half of the screen, rather than in the center -->
		</div>
	</div>
</body>