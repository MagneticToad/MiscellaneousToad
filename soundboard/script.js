//###media keys
//###remove specific sounds

const URL = "https://discord.com/api/webhooks/874951532985069578/LvVbvYIWJQkt1WAVunGMdCwKz1zay2lokJxyiRumlBnq8bVFdqct5vep6c6t1Ksdl7C5";

const KEYS = ["1","2","3","4","5","6","7","8","9","0","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"];
var count = 0;
var soundboardButtons = [];

function initPageManagement() {
	$("#soundToAdd").on("keyup", function(e) {
		if (e.keyCode == 13) {
			addSound();
		}
	});
	$(document).on("keyup", function(e) {
		if (!$(e.target).closest("input")[0]) { //if not in an input
			let key = whichToKey(e.which);
			let index = KEYS.indexOf(key);
			if (index != -1 && index < count) { //if sound exists
				$(soundboardButtons[index]).trigger("click");
			}
		}
	});
	let url = window.location.href;
	/*
	URLs are generated by the bot
	The structure is {URL}?{sound1},{sound2},{soundX}#{sound1},{sound2},{soundX}
	Sounds after ? represent available sounds, and a button will be shown that will allow players to add it to the board
	Sounds after # will immediately be added to the board
	*/
	if (url.includes("#")) {
		let soundsList = url.substr(url.indexOf("#")+1); //get the list of sounds
		url = url.substring(0, url.indexOf("#")); //remove these sounds from the URL so the ? loading is easier
		let soundsToAdd = soundsList.split(",");
		let holder = $("#availableSounds")[0];
		soundsToAdd.forEach(sound => {
			$("#soundToAdd")[0].value = sound; //OMEGA SCUFFED
			addSound();
		});
	}
	if (url.includes("?")) {
		let soundsList = url.substr(url.indexOf("?")+1);
		let availableSounds = soundsList.split(",");
		let holder = $("#availableSounds")[0];
		availableSounds.forEach(sound => {
			let button = document.createElement("button");
			button.value = sound;
			button.onclick = function(e) {
				$("#soundToAdd")[0].value = e.target.value; //OMEGA SCUFFED
				addSound();
			}
			button.innerHTML = sound;
			holder.appendChild(button);
		});
	}
	if (false) {
		window.history.replaceState(null, null, "."); //remove the sounds from the url
	}
	
}

function addSound(name) {
	let element = $("#soundToAdd")[0];
	
	let div = document.createElement("div");
	div.classList.add("soundboardButtonHolder");
	
	let label = document.createElement("h3");
	let soundName = element.value;
	div.value = soundName;
	label.innerHTML = soundName;
	div.onclick = function(e) {
		playSound(e.target.value);
	}
	element.value = "";
	
	div.appendChild(label);
	let key = document.createElement("p");
	key.innerHTML = KEYS[count] ? KEYS[count] : ""; //if a key is available, use it; otherwise, keep it blank (this stops is showing undefined below the 37th button and onwards
	div.appendChild(key);
	
	$("#soundboardButtons")[0].appendChild(div);
	$(".soundboardButtonHolder").on("click", function(e) {
		console.log("click");
		e.target.classList.add("pressed");
		setTimeout(() => e.target.classList.remove("pressed"), 100);
	});
	soundboardButtons.push(div);
	count++;
	if (!$("#fastAdd")[0].checked) {
		element.blur();
	}
}

function playSound(name) {
	$.post(URL, {content: `\$p ${name}`});
}

function clearSounds() {
	$("#soundboardButtons")[0].innerHTML = "";
	count = 0;
	soundboardButtons = [];
}

function removeLastSound() {
	if (count > 0) {
		count--;
		soundboardButtons.pop();
		let div = $("#soundboardButtons")[0];
		div.removeChild(div.lastChild);
	}
}

function whichToKey(code) {
	if (code >= 96 && code <= 105) {
		code -= 48; //convert numpad presses into their respective number
	}
	return String.fromCharCode(code);
}